"use strict";angular.module("mufcg",["ngAnimate","ui.bootstrap","ui.router","ngMap","naif.base64"]),angular.module("mufcg").controller("MapModalCtrl",["$scope","LOCATIONS","NgMap","messagebox","$uibModalInstance","mapHelper",function(e,t,n,o,a,r){function l(t,n,o){e.marker={lat:t,lng:n,geolocation:o}}var i=void 0,s=void 0;n.getMap().then(function(e){i=e,google.maps.event.trigger(i,"resize"),i.setCenter(t.UFCG.center),s=r.getPolygon(t.UFCG.polygon),r.deleteAllMarkers()}),e.createMarker=function(e){var t=e.latLng.lat(),n=e.latLng.lng();if(google.maps.geometry.poly.containsLocation(e.latLng,s)){r.getMarkers().length>0&&r.deleteAllMarkers();var a=new google.maps.Marker;a.setMap(i),a.setPosition(e.latLng),a.setTitle("Nova ocorrência"),r.addMarker(a),l(t,n,!1)}else o.fail("O local que você escolheu para criar a ocorrência fica fora das dependências do seu campus","Local inválido")},e.getLocation=function(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(e){var t={lat:function(){return e.coords.latitude},lng:function(){return e.coords.longitude}},n={lat:e.coords.latitude,lng:e.coords.longitude};if(google.maps.geometry.poly.containsLocation(t,s)){i.setCenter(n);var a=new google.maps.Marker;a.setMap(i),a.setPosition(n),l(n.lat,n.lng,!0),r.addMarker(a)}else o.fail("Você não está no campus, não é possível marcar esta localização","Local inválido")},function(){o.fail("Você bloqueou o acesso da aplicação a sua localização. Sem sua permissão não será possível a atualização de funcionalidades com geolocalização.<br><br><a target='_blank' href='/'>Clique aqui para saber como desbloquear</a>")})},e.dragLimit=function(){r.dragEnd(s,t.UFCG.center)},e.ok=function(){a.close(e.marker)},e.cancel=function(){a.dismiss("cancel")}}]);var app=angular.module("mufcg");app.config(["$stateProvider","$urlRouterProvider","$locationProvider","$httpProvider",function(e,t,n,o){e.state({name:"login",url:"/",templateUrl:"/templates/pages/login.html",controller:"LoginCtrl"}),e.state({name:"register",url:"/register",templateUrl:"/templates/pages/register.html",controller:"RegisterCtrl"}),e.state({name:"create_request",url:"/request/create",templateUrl:"/templates/pages/create-request.html",controller:"CreateRequestCtrl"}),e.state({name:"home",url:"/home",templateUrl:"/templates/pages/home.html",controller:"HomeCtrl"}),t.otherwise("/"),n.html5Mode(!0),o.interceptors.push("BearerAuthInterceptor")}]),app.factory("BearerAuthInterceptor",["$injector","$q","$state",function(e,t,n){return{request:function(t){var n=e.get("AuthService");if(t.headers=t.headers||{},n.isLoggedIn()){var o=n.getToken();t.headers.Authorization="Bearer "+o}return t},responseError:function(e){return 401!==e.status&&403!==e.status||n.go("login"),t.reject(e)}}}]),app.run(["AuthService","$transitions","$state","$location",function(e,t,n,o){var a={login:!0,register:!0};t.onStart({to:function(t){return!a[t.name]&&!e.isLoggedIn()}},function(e){n.go("login",{redirect:o.path()})})}]),angular.module("mufcg").constant("LOCATIONS",{UFCG:{polygon:[{lat:-7.211582063794847,lng:-35.908427238464355},{lat:-7.211954602379666,lng:-35.90901732444763},{lat:-7.21215683748306,lng:-35.90925335884094},{lat:-7.212603883180555,lng:-35.9093177318573},{lat:-7.213178655571561,lng:-35.9093177318573},{lat:-7.213561836760166,lng:-35.909414291381836},{lat:-7.213998237163229,lng:-35.90957522392273},{lat:-7.21434948596254,lng:-35.90980052947998},{lat:-7.214604939463547,lng:-35.91011166572571},{lat:-7.2147965294947145,lng:-35.9103262424469},{lat:-7.214988119444751,lng:-35.910712480545044},{lat:-7.2152116409506375,lng:-35.91112017631531},{lat:-7.2153819429762605,lng:-35.911463499069214},{lat:-7.21560546428765,lng:-35.911903381347656},{lat:-7.215818341624408,lng:-35.91227889060974},{lat:-7.216105725870212,lng:-35.91256856918335},{lat:-7.216414397634615,lng:-35.912686586380005},{lat:-7.2166485622809615,lng:-35.912718772888184},{lat:-7.21695723367506,lng:-35.91247200965881},{lat:-7.21697852134966,lng:-35.912150144577026},{lat:-7.217106247376168,lng:-35.91150641441345},{lat:-7.21718075420832,lng:-35.910948514938354},{lat:-7.21722332953546,lng:-35.91048717498779},{lat:-7.217329767835804,lng:-35.91002583503723},{lat:-7.217340411664459,lng:-35.90956449508667},{lat:-7.217382986976575,lng:-35.90938210487366},{lat:-7.217265904858604,lng:-35.90904951095581},{lat:-7.217106247376168,lng:-35.908459424972534},{lat:-7.21697852134966,lng:-35.907922983169556},{lat:-7.216776288400609,lng:-35.907440185546875},{lat:-7.216637918436021,lng:-35.906914472579956},{lat:-7.216542123820367,lng:-35.90656042098999},{lat:-7.216414397634615,lng:-35.90588450431824},{lat:-7.216371822231359,lng:-35.90559482574463},{lat:-7.215541601067087,lng:-35.90563774108887},{lat:-7.214924256137079,lng:-35.905680656433105},{lat:-7.21348732933222,lng:-35.905659198760986},{lat:-7.212359072496125,lng:-35.905669927597046},{lat:-7.212061041919028,lng:-35.90564846992493},{lat:-7.211880094687213,lng:-35.905702114105225},{lat:-7.211603351722236,lng:-35.90587377548218},{lat:-7.211401116371638,lng:-35.90612053871155},{lat:-7.211284032706316,lng:-35.906431674957275},{lat:-7.211262744763913,lng:-35.906742811203},{lat:-7.211198880930712,lng:-35.907193422317505},{lat:-7.211188236957634,lng:-35.90764403343201}],center:{lat:-7.21425,lng:-35.909188}}});var BASE_PATH="api";angular.module("mufcg").constant("PROPERTIES",{restBasePath:BASE_PATH}),angular.module("mufcg").controller("CreateRequestCtrl",["$scope","AuthService","Request","$uibModal","messagebox","$location",function(e,t,n,o,a,r){e.create=function(){e.request.title&&e.request.priority&&e.request.location&&e.request.location.lat&&e.request.location.lng&&n.create(t.getCurrentUser().id,e.request).then(function(){a.success("Solicitação cadastrada com sucesso",void 0,void r.url("/home"))},function(e){a.fail("Ocorreu um erro na criação da solicitação")})},e.pop=function(){o.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"/templates/components/map-modal.html",controller:"MapModalCtrl",scope:this,size:"xl"}).result.then(function(t){e.request.location.lat=t.lat,e.request.location.lng=t.lng,e.request.location.geolocation=t.geolocation})}}]),angular.module("mufcg").controller("HomeCtrl",["$scope","NgMap","mapHelper","LOCATIONS","AuthService","Request",function(e,t,n,o,a,r){function l(){r.getByAuthor(a.getCurrentUser().id).then(function(e){e.data.forEach(function(e){var t={};if("location"in e){t.lat=e.location.lat,t.lng=e.location.lng;var o=void 0;e.img&&(o="data:".concat(e.img.filetype,";base64,",e.img.base64)),function(e,t,o,a,r){var l="<h1>"+e+"</h1><p>"+t+'</p><img src="'+o+'" /><p>'+a+"</p>",s=new google.maps.InfoWindow({content:l}),c=new google.maps.Marker;c.setMap(i),c.setPosition(r),c.setTitle(e),c.addListener("click",function(){s.open(i,c)}),n.addMarker(c)}(e.title,e.description,o,e.createdOn,t)}})})}var i=void 0,s=void 0;e.initMap=function(){t.getMap().then(function(e){i=e,n.getMap()||n.initMap(i),n.deleteAllMarkers(),s=n.getPolygon(o.UFCG.polygon),l()})},e.dragLimit=function(){n.dragEnd(s,o.UFCG.center)}}]),angular.module("mufcg").controller("LoginCtrl",["$scope","User","AuthService","$state","messagebox",function(e,t,n,o,a){e.login=function(){var t={registration:e.registration,password:e.password};n.login(t).then(function(e){o.go("home")},function(e){a.fail("Matrícula ou senha incorretos")})}}]),angular.module("mufcg").controller("RegisterCtrl",["$scope","$state","AuthService",function(e,t,n){e.register=function(){e.user.password!==e.confirmPassword?alert("Senhas divergem!"):(e.user.role="student",n.register(e.user).then(function(){alert("Usuário cadastrado com sucesso"),t.go("login")},function(e){console.warn(e.message)}))}}]),angular.module("mufcg").service("AuthService",["$q","$http","$window",function(e,t,n){function o(){var e,t=r();return t&&(e=t.split(".")[1],e=n.atob(e),e=JSON.parse(e)),e}var a=function(e){n.localStorage.token=e},r=function(){return n.localStorage.token},l=function(){r();var e=o();if(e){return e.exp>Date.now()/1e3}return!1};return{saveToken:a,getToken:r,logout:function(){n.localStorage.removeItem("token")},login:function(n){var o=e.defer();return t.post("/api/login",n).then(function(e){a(e.data.token),o.resolve(e)},function(e){o.reject(e)}),o.promise},isLoggedIn:l,register:function(n){var o=e.defer();return t.post("/api/users",n).then(function(e){a(e.data.token),o.resolve()},function(e){o.reject(e)}),o.promise},getCurrentUser:function(){if(l()){var e=o();return{name:e.name,registration:e.registration,id:e.id}}}}}]),angular.module("mufcg").service("mapHelper",["NgMap",function(e){function t(){for(var e=0;e<n.length;e++)n[e].setMap(null)}var n=[],o=void 0;return{initMap:function(e){o=e},getMap:function(){return o},addMarker:function(e){n.push(e)},getMarkers:function(){return n},hideMarkers:function(){t()},showAllMarkers:function(){for(var e=0;e<n.length;e++)n[e].setMap(o)},deleteAllMarkers:function(){t(),n=[]},getPolygon:function(e){return new google.maps.Polygon({paths:e})},dragEnd:function(e,t){google.maps.geometry.poly.containsLocation(o.getCenter(),e)||o.setCenter(t)}}}]),angular.module("mufcg").service("messagebox",function(){function e(e,t,n,o){var a={};return a[e]={label:t,className:n,callback:o||function(){}},a}function t(e,t,n){return"<div style='color: "+t+(n?"; font-weight : bold'>":"'>")+e+"</div>"}var n=function(e,t,n,o,a,r,l){bootbox.dialog({title:e,message:t,size:n||"small",buttons:o||{},closeButton:a,className:r||"",callback:l||function(){}})};return{success:function(o,a,r){n(t(a||"Sucesso","white",!0),o,"small",e("ok","OK","btn-success"),!1,"success-modal")},fail:function(o,a,r){n(t(a||"Falha de autenticação","white",!0),o,"small",e("ok","OK","btn-danger"),!1,"danger-modal")},custom:n}}),angular.module("mufcg").factory("Request",["$http","PROPERTIES",function(e,t){return{create:function(n,o){var a={author:n,request:o};return e.post(t.restBasePath+"/requests",a,{headers:{"Content-Type":"application/json; charset=UTF-8"}})},getByAuthor:function(n){return e.get(t.restBasePath+"/user/"+n+"/requests/")}}}]),angular.module("mufcg").factory("User",["$http","PROPERTIES",function(e,t){return{}}]),angular.module("mufcg").directive("logo",function(){return{restrict:"AE",templateUrl:"/templates/directives/logo/logo.html"}}),angular.module("mufcg").directive("navBar",function(){return{restrict:"AE",templateUrl:"/templates/directives/nav-bar/nav-bar.html",scope:{page:"="},controller:["$scope","$location",function(e,t){e.enabled=!1,e.collapsed=!1;var n=["/login","/register","/"];e.getCollapseClass=function(){return e.isCollapsed?"collapse navbar-collapse is-collapsed":"collapse navbar-collapse"},e.test=function(){e.collapsed=!e.collapsed},e.getCollapsedStyle=function(){return e.collapsed?{"margin-top":"28px","z-index":20}:{}},e.isActive=function(t){return t===e.page?"active":""},e.$on("$locationChangeSuccess",function(o){console.log(t.url()),e.enabled=t.url()&&-1===n.indexOf(t.url()),console.log(e.enabled)})}]}});